name: Auto-Minify JavaScript

on:
  push:
    branches:
      - main
    paths:
      - '**/*.js'
      - '!**/*.min.js'
  workflow_dispatch: 

permissions:
  contents: write

jobs:
  minify: 
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with: 
          node-version: '20'

      - name: Install Terser
        run: npm install -g terser

      - name: Minify all JavaScript files
        run: |
          # Minify shared licensing
          if [ -f "_shared/licensing.js" ]; then
            terser _shared/licensing.js --compress --mangle keep_classnames=true --comments "/^!/" --output _shared/licensing.min.js
            echo "✅ Minified _shared/licensing.js"
          fi
          
          # Minify all plugin files
          find . -name "*.js" -not -name "*.min.js" -not -path "*/node_modules/*" -not -path "*/.git/*" -not -path "*/scripts/*" | while read file; do
            dir=$(dirname "$file")
            base=$(basename "$file" .js)
            output="$dir/$base.min.js"
            
            if terser "$file" --compress --mangle keep_classnames=true --comments "/^!/" --output "$output"; then
              echo "✅ Minified: $file → $output"
            fi
          done

      - name: Commit and push if changed
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-minify JavaScript files [skip ci]"
          file_pattern: "**/*.min.js"
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com
